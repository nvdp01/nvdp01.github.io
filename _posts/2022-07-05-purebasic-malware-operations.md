---
layout: post
title: "Operations of an APT malware written in PureBasic"
categories: re
---

My previous [post] was about a [maldoc] which dropped a malware using strings stored as values of various OLE form fields. The [dropped malware] is written in [PureBasic]. There are very few public reports about malware written in PureBasic.

The operations of the dropped malware are presented here. It has basic remote access capabilities such as running commands remotely, and installing additional files/malware as desired by the threat actors. This malware probably belongs to North Korean [Lazarus] APT Group.

### Malware characteristics

The file is a 64-bit PE exe and has a compilation timestamp of 2021-11-07 06:46:03 UTC. It is compiled with PureBasic 4.X compiler.
Most of the strings used by the malware, including the C2 server address, are stored with XOR encryption using the key _`n>t#8;S<`_ followed by base64 encoding, and are decrypted at runtime as needed. The malware contains multiple long `Sleep()` calls, some of which have randomly generated delays.

The C2 IP address **40[.]121[.]90[.]194** runs a web server and the malware communicates with it via POST web requests over HTTP.

A 32-bit version of this malware, compiled 4 seconds before this one, is also [present] on VirusTotal.

### POST request format

The malware sends POST requests to C2 at path **/help.php**. It uses `Mozilla/5.0 (Windows NT 10.0 WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36` as the User Agent string.

The POST request body can contain upto four parameters:

1. ***id*** &nbsp;(required): Eight hex digits (4 bytes) CRC32 checksum of a concatenated string formed from MAC address, System Name and IP address of the victim system. It is used as an ID as well as a XOR key for encrypting ***query*** &nbsp;and ***rep0*** &nbsp;POST parameter values.

2. ***page*** &nbsp;(optional): Two digit code indicating status of last response received from C2. Possible codes and their meanings are given at the end of the post.

3. ***query*** &nbsp;(required): Encoded and XOR encrypted string containing basic system information. Following values are first concatenated with a pipe `|` symbol between values:
- IP address
- System Name
- User Name
- [#PB_OS_Windows] enum value (equals _110_ on Windows 10, for example)
- OS bitness (64 for 64-bit, 86 for 32-bit)  
The string is then XOR encrypted with ***id*** &nbsp;value, base64 encoded and finally URL encoded.

4. ***rep0*** &nbsp;(optional): Encoded and XOR encrypted string containing output of last command received from C2. The string contains the command (with arguments, if any) followed by a line of 40 hyphens `-` followed by the command output on a newline. The total length of this string must be at least 54 characters for ***rep0*** &nbsp;to be included in the POST request. Like ***query*** &nbsp;value, this string is also XOR encrypted with ***id*** &nbsp;value, base64 encoded and then URL encoded.

### C2 response format

If the C2 server returns HTTP response status code **504**, the malware deletes itself with command `cmd /c ping /n 3 127.0.0.1 > NUL & del /q /f <filename>`.

HTTP response status code **500** is sent for regular operations of the malware. In this case, the POST response body contains instructions from the server.

A sample POST response from the C2 is shown below:

![Color coded sample POST response from C2 server](/assets/post_images/2022-07-05-purebasic-malware-operations/POST_response.png)

- <span style="background-color: #a8a8a8">Unused 10 bytes</span>: The POST response body starts with 10 random unused bytes.
- <span style="background-color: #ffe5cf">8 byte signature</span>: The next 8 bytes from 0xA to 0x11 are a fixed signature. These bytes must be _[0x0B, 0x15, 0x1F, 0x29, 0x33, 0x3D, 0x47, 0x51]_ for the response to be considered valid. The bytes are _[11, 21, 31 .. 81]_ in decimal.
- <span style="background-color: #fdf481">8 byte XOR key</span>: The 8 bytes from 0x12 to 0x19 are used as a XOR key. The remaining bytes in the POST response are XOR encrypted with this key.

The same POST response with bytes from 0x1A decrypted with XOR key are shown below:

![Same POST response showing XOR decrypted bytes](/assets/post_images/2022-07-05-purebasic-malware-operations/POST_response_XORed.png)

The meaning of remaining bytes after XOR decryption is as follows:

- <span style="background-color: #7fffff">1 byte command string length</span>: Byte 0x1A has value equal to length of command string (with arguments, if any) which starts from the next byte.
- <span style="background-color: #80cffe">Command string with arguments</span>: Bytes starting from 0x1B represent a command to be executed by the malware. The substring after first space in the string is used as argument for the command. The output of the command is sent to the C2 server in next POST request as value of ***rep0*** &nbsp;parameter.
- <span style="background-color: #b8fdb6">1 byte drop file path length </span>_(optional)_ : The next byte (if present) after command string has value equal to length of drop file path string which starts from the next byte.
- <span style="background-color: #7fdf7f">Drop file path </span>_(present only if drop file path length byte is present)_ : These bytes represent a path with filename for a file to be dropped on the system.
- <span style="background-color: #98cdbd">Drop file bytes </span>_(present only if drop file path string is present)_ : The remaining bytes following the path string are the bytes of the file to be dropped on the system.

The malware creates a temporary file in _%TEMP%_ directory, writes the POST response body into the file and then parses the response. The name of the temporary file is _n_.tmp where _n_ is a random number between 100 and 999. The file is deleted before the next POST request is sent.

Any file dropped by the malware is [hidden] and [timestomped] to match the timestamps of **c:\windows\system32\explorer.exe**. It may be noted that _explorer.exe_ does not exist in _system32_ folder on 64 bit Windows systems. The timestamps are set to Epoch zero (1 January 1970 00:00:00 UTC) in this case. 

If the dropped file's name ends with "exe" or "EXE", 40000000 (~38 MB) random bytes are appended to the file.

### ***page*** status values

Possible values of ***page*** POST parameter along with their meaning are given below:

Value|Meaning
----|----
13|Successfully parsed and executed last response
----|----
20|Error. Response data body has length <=1
----|----
21|Error. Response data body has length from 2 to 27
----|----
22|Error. 8 byte signature (from bytes 0xA to 0x11) is missing
----|----
23|Error. Length of command string is less than expected
----|----
24|Error. Length of drop file path string is less than expected
----|----
25|Error. Could not create temporary file for writing POST response body
----|----
11|(Temporary) Set internally during processing of response by the malware

---

Except what is described above, the malware has no other functional capabilities.

---
---
[post]: {% post_url 2022-06-29-extracting-vba-userform-field-values %}
[maldoc]: https://www.virustotal.com/gui/file/303bc0f4742c61166d05f7a14a25b3c118fa3ba04298b8370071b4ed19f1a987/details
[dropped malware]: https://www.virustotal.com/gui/file/83388741cb6e6ee7341ae00cb9ab92c8a0132d92307473a4c08e678153a27cef/details
[PureBasic]: https://en.wikipedia.org/wiki/PureBasic
[Lazarus]: https://attack.mitre.org/groups/G0032/
[present]: https://www.virustotal.com/gui/file/faba4114ada285987d4f7c771f096e0a2bc4899c9244d182db032acd256c67aa/details
[#PB_OS_Windows]: https://www.purebasic.com/documentation/system/osversion.html
[hidden]: https://attack.mitre.org/techniques/T1564/001/
[timestomped]: https://attack.mitre.org/techniques/T1070/006/

